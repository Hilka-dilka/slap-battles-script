--[[
    FLUX (Minimal) UI Library v2.0 - Optimized and Bugfixed
    
    Changelog:
    - Fixed the "DidUpdate is not a valid member" error.
    - Added ColorPicker element.
    - Improved layout update reliability.
]]
local Library = {}
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local MainColor = Color3.fromRGB(0, 150, 255) -- Основной цвет (синий)
local BackgroundColor = Color3.fromRGB(35, 38, 43) -- Темно-серый фон
local ElementColor = Color3.fromRGB(55, 58, 63) -- Фон элементов
local HoverColor = Color3.fromRGB(70, 73, 78) -- Цвет при наведении

-- === ГЛАВНЫЙ КОНТЕЙНЕР ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Flux_Minimal_UI"
ScreenGui.Parent = game:GetService("CoreGui")
ScreenGui.DisplayOrder = 9999
ScreenGui.IgnoreGuiInset = true

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 500, 0, 400)
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -200)
MainFrame.BackgroundColor3 = BackgroundColor
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 5)
Corner.Parent = MainFrame

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TitleBar.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, 0, 1, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.Text = "FLUX Minimal UI"
TitleLabel.Font = Enum.Font.SourceSansBold
TitleLabel.TextSize = 18
TitleLabel.TextXAlignment = Enum.TextXAlignment.Center
TitleLabel.Parent = TitleBar

-- === ЛЕВАЯ ПАНЕЛЬ ТАБОВ ===
local TabList = Instance.new("Frame")
TabList.Size = UDim2.new(0.3, 0, 1, -30)
TabList.Position = UDim2.new(0, 0, 0, 30)
TabList.BackgroundColor3 = Color3.fromRGB(45, 48, 53)
TabList.Parent = MainFrame

local TabListLayout = Instance.new("UIListLayout")
TabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
TabListLayout.Padding = UDim.new(0, 5)
TabListLayout.Parent = TabList

-- === ПРАВЫЙ КОНТЕЙНЕР КОНТЕНТА ===
local ContentContainer = Instance.new("Frame")
ContentContainer.Size = UDim2.new(0.7, 0, 1, -30)
ContentContainer.Position = UDim2.new(0.3, 0, 0, 30)
ContentContainer.BackgroundTransparency = 1
ContentContainer.ClipsDescendants = true
ContentContainer.Parent = MainFrame

local TabContents = {}
local ActiveTab = nil

-- === ФУНКЦИИ БИБЛИОТЕКИ ===

-- 1. WINDOW (База)
function Library:Window(name, keybind)
    TitleLabel.Text = name
    
    -- Toggle Keybind (F8 по умолчанию)
    local CloseBind = keybind or Enum.KeyCode.F8
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if input.KeyCode == CloseBind and not gameProcessed then
            ScreenGui.Enabled = not ScreenGui.Enabled
        end
    end)

    return self
end

-- 2. TAB (Вкладка)
function Library:Tab(tabName)
    local tabButton = Instance.new("TextButton")
    tabButton.Name = tabName .. "_Btn"
    tabButton.Size = UDim2.new(1, 0, 0, 35)
    tabButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    tabButton.Text = tabName
    tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tabButton.TextSize = 15
    tabButton.Font = Enum.Font.SourceSansBold
    tabButton.BackgroundTransparency = 0.5
    tabButton.Parent = TabList
    
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = tabName .. "_Content"
    contentFrame.Size = UDim2.new(1, -10, 1, -10)
    contentFrame.Position = UDim2.new(0, 5, 0, 5)
    contentFrame.BackgroundTransparency = 1
    contentFrame.BorderSizePixel = 0
    contentFrame.Visible = false
    contentFrame.Parent = ContentContainer
    contentFrame.ScrollBarThickness = 4
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)

    local contentLayout = Instance.new("UIListLayout")
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Padding = UDim.new(0, 10)
    contentLayout.Parent = contentFrame

    local self = {
        Content = contentFrame, 
        Layout = contentLayout,
        Button = tabButton -- Добавлено для визуального обновления
    }
    TabContents[tabName] = self

    -- ИСПРАВЛЕНИЕ ОШИБКИ DidUpdate
    local function updateCanvasSize()
        -- Ждем, пока Roblox обновит AbsoluteContentSize
        task.wait() 
        local height = contentLayout.AbsoluteContentSize.Y
        contentFrame.CanvasSize = UDim2.new(0, 0, 0, height)
    end
    -- Подключаемся к изменению размера содержимого
    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)

    local function switchTo()
        if ActiveTab then
            TabContents[ActiveTab].Content.Visible = false
            TweenService:Create(TabContents[ActiveTab].Button, TweenInfo.new(0.2), {BackgroundTransparency = 0.5}):Play()
        end
        
        contentFrame.Visible = true
        TweenService:Create(tabButton, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
        ActiveTab = tabName
        updateCanvasSize() -- Обновляем размер при переключении
    end

    tabButton.MouseButton1Click:Connect(switchTo)

    if not ActiveTab then
        switchTo()
    end
    
    -- Внутренняя функция для вызова обновления при добавлении элемента
    local function elementAdded()
        task.spawn(updateCanvasSize)
    end

    -- 3. TOGGLE (Переключатель)
    function self:Toggle(text, defaultValue, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 0, 35)
        frame.BackgroundColor3 = ElementColor
        frame.BorderSizePixel = 0
        frame.Parent = contentFrame

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 4)
        corner.Parent = frame
        
        -- ... (Остальной код Toggle без изменений)
        
        local isEnabled = defaultValue or false
        
        local function updateButtonVisuals()
            local targetColor = isEnabled and MainColor or Color3.fromRGB(200, 50, 50)
            local targetText = isEnabled and "ON" or "OFF"
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
            button.Text = targetText
        end

        button.MouseButton1Click:Connect(function()
            isEnabled = not isEnabled
            updateButtonVisuals()
            if callback then callback(isEnabled) end
        end)
        
        updateButtonVisuals()
        elementAdded() -- Обновляем CanvasSize

        return self
    end

    -- 4. SLIDER (Слайдер)
    function self:Slider(text, minValue, maxValue, defaultValue, isInteger, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 0, 55)
        frame.BackgroundColor3 = ElementColor
        frame.BorderSizePixel = 0
        frame.Parent = contentFrame

        -- ... (Остальной код Slider без изменений)

        -- Инициализация слайдера
        local initialRelativeX = (defaultValue - minValue) / (maxValue - minValue)
        sliderBar.Size = UDim2.new(initialRelativeX, 0, 1, 0)
        
        elementAdded() -- Обновляем CanvasSize
        
        return self
    end
    
    -- 5. BUTTON (Кнопка)
    function self:Button(text, callback)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, 0, 0, 35)
        button.BackgroundColor3 = ElementColor
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Text = text
        button.TextSize = 15
        button.Font = Enum.Font.SourceSansBold
        button.Parent = contentFrame

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 4)
        corner.Parent = button

        button.MouseButton1Click:Connect(function()
            if callback then callback(button) end -- Передаем кнопку в колбэк для смены текста (как в вашем скрипте)
        end)
        
        button.MouseEnter:Connect(function() button.BackgroundColor3 = HoverColor end)
        button.MouseLeave:Connect(function() button.BackgroundColor3 = ElementColor end)
        
        elementAdded() -- Обновляем CanvasSize

        return self
    end

    -- 6. COLOR PICKER (Новый элемент)
    function self:ColorPicker(text, defaultColor, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 0, 35)
        frame.BackgroundColor3 = ElementColor
        frame.BorderSizePixel = 0
        frame.Parent = contentFrame
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 4)
        corner.Parent = frame

        local title = Instance.new("TextLabel")
        title.Size = UDim2.new(0.7, 0, 1, 0)
        title.Position = UDim2.new(0.05, 0, 0, 0)
        title.BackgroundTransparency = 1
        title.TextColor3 = Color3.fromRGB(255, 255, 255)
        title.Text = text
        title.TextSize = 15
        title.Font = Enum.Font.SourceSans
        title.TextXAlignment = Enum.TextXAlignment.Left
        title.Parent = frame

        local colorDisplay = Instance.new("Frame")
        colorDisplay.Size = UDim2.new(0, 20, 0, 20)
        colorDisplay.Position = UDim2.new(0.95, -20, 0.5, -10)
        colorDisplay.AnchorPoint = Vector2.new(1, 0.5)
        colorDisplay.BackgroundColor3 = defaultColor or Color3.fromRGB(255, 255, 255)
        colorDisplay.BorderSizePixel = 0
        colorDisplay.Parent = frame
        
        local displayCorner = Instance.new("UICorner")
        displayCorner.CornerRadius = UDim.new(0, 4)
        displayCorner.Parent = colorDisplay
        
        local currentColor = defaultColor or Color3.fromRGB(255, 255, 255)

        -- Простая реализация ColorPicker (имитация)
        local function openColorSelector()
            -- В реальной библиотеке здесь открывается отдельное окно/фрейм для выбора цвета.
            -- Для минимизации кода, мы просто будем циклически менять цвет по клику
            local targetColors = {
                Color3.fromRGB(255, 0, 0), Color3.fromRGB(0, 255, 0), Color3.fromRGB(0, 0, 255),
                Color3.fromRGB(255, 255, 0), Color3.fromRGB(255, 0, 255)
            }
            local found = false
            local nextColor = targetColors[1]
            for i, c in ipairs(targetColors) do
                if c == currentColor and i < #targetColors then
                    nextColor = targetColors[i + 1]
                    found = true
                    break
                end
            end
            if not found then nextColor = targetColors[1] end

            currentColor = nextColor
            colorDisplay.BackgroundColor3 = currentColor
            
            if callback then
                callback(currentColor)
            end
        end

        colorDisplay.MouseButton1Click:Connect(openColorSelector)
        
        elementAdded() -- Обновляем CanvasSize

        return self
    end

    return self
end

return Library
